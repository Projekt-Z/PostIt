@using Microsoft.AspNetCore.Mvc.TagHelpers
@using PostIt.Web.Services
@model IEnumerable<Post>

@inject IUserService _userService

@{
    ViewData["Title"] = "Home Page";
}

@if (Context.User.Identity.IsAuthenticated)
{
    var user = _userService.GetByUsername(User.Identity.Name);
    
    <div id="who_to_follow" class="w-25 h-auto">
        <h5>Who to follow?</h5>
        @foreach (var user1 in _userService.GetMostFollowedDesc(5))
        {
            <div>
                <h6>
                    <img alt="profile" src="@user1.ImageUrl" width="20" height="20" class="rounded-circle"/>
                    <a asp-action="Index" asp-controller="Profile" asp-route-username="@user1.Username">@user1.Username</a>
                </h6>

                <a>Followers: @user1.Followers.Count</a>
                
                @if (!user!.Following.Contains(new Following { UserId = user1.Id}))
                {
                    <a asp-action="Follow" asp-route-id="@user1.Id">Follow</a>
                }
                  
                <hr />
            </div>
        }
    </div>
    
    <div class="text-center">
        <h1 class="display-4">Welcome @Context.User.Identity.Name !</h1>
        
        <p>
            <a asp-action="Post" asp-controller="Home">Write a Post!</a>
        </p>
        
        <div class="main-posts">
            @foreach (var post in Model)
            {
                <h4>@post.Title</h4>

                <p>@post.Description</p>
                <a>@post.TimeAdded |</a> 
                <a asp-action="Index" asp-controller="Profile" asp-route-username="@post.Author.Username">@post.Author.Username</a>
                
                @if (post.Author.Username == Context.User.Identity.Name)
                {
                    <a asp-action="Delete" asp-route-id="@post.Id">Delete</a>
                }

                if (!post.Author.Equals(_userService.GetByUsername(User.Identity.Name)) && !user!.Following.Contains(new Following { UserId = post.Author.Id}))
                {
                    <a asp-action="Follow" asp-route-id="@post.Author.Id">Follow</a>
                }
                
                if (!post.Likes.Contains(user))
                {
                    <a asp-action="Like" asp-route-id="@post.Id">Like</a>
                }
                else if (post.Likes.Contains(user))
                {
                    <a asp-action="Unlike" asp-route-id="@post.Id">Unlike</a>
                }
                
                <p> <a>&#10084; @post.Likes.Count</a> </p>
                
                <hr/>
            }
        </div>
        
    </div>
}
else
{
    <p class="text-center">Please
    
        <a asp-controller="Authentication" asp-action="GoogleLogin">Log In with google</a> <br/>
        <a asp-controller="User" asp-action="Create">Create new account</a> <br/>
        <a asp-controller="User" asp-action="Login">Log In</a> <br/>
        
        in order to use this App
    </p>
}